---
name: Publish Python üêç distributions üì¶ to PyPI
  on:
    push:
      tags:
        - "*"
  jobs:
    build-and-publish-test-pypi:
      runs-on: ubuntu-latest
      outputs:  
        version: ${{ steps.tag.outputs.TAG_NAME }} # Assuming you have a step with id 'tag' that outputs the tag name 
      environment: 
        name: pypi
        url: https://test.pypi.org/p/dspy-ai-test 
      permissions:
        id-token: write  # IMPORTANT: mandatory for trusted publishing
      steps:
        - uses: actions/checkout@master
        - name: Set up Python 3.9
          uses: actions/setup-python@v3
          with:
            python-version: "3.9"
        - name: Install dependencies
          run: python3 -m pip install setuptools wheel twine
        - name: Extract tag name
          id: tag
          run: echo ::set-output name=TAG_NAME::$(echo $GITHUB_REF | cut -d / -f 3)
        - name: Update version in setup.py
          run: sed -i "s/{{VERSION_PLACEHOLDER}}/${{ steps.tag.outputs.TAG_NAME }}/g"
            setup.py
        - name: Update version in pyproject.toml
          run: sed -i "s/{{VERSION_PLACEHOLDER}}/${{ steps.tag.outputs.TAG_NAME }}/g"
            pyproject.toml
        - name: Build a binary wheel
          run: python3 setup.py sdist bdist_wheel
        - name: Publish distribution üì¶ to PyPI
          uses: pypa/gh-action-pypi-publish@release/v1 # This requires a trusted publisher to be setup in pypi/testpypi
          with: 
            repository-url: https://test.pypi.org/legacy/

    test-intro-script: 
      needs: build-and-publish-test-pypi
      runs-on: ubuntu-latest
      steps:  
        - uses: actions/checkout@v2  
        - name: Set up Python 3.9  
          uses: actions/setup-python@v3
          with:  
            python-version: "3.9"  
        - name: Install package from TestPyPI  
          run: |  
            python3 -m pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple your-package-name==${{ needs.build-and-publish-test-pypi.outputs.version }}  
        - name: Run Python script
          run: |  
            python3 tests/build/intro.py  


    # build-and-publish-pypi:
    #   needs: [build-and-publish-test-pypi, test-intro-notebook]
    #   runs-on: ubuntu-latest
    #   environment: 
    #     name: pypi
    #     url: https://pypi.org/p/dspy-ai
    #   permissions:
    #     id-token: write  # IMPORTANT: mandatory for trusted publishing
    #   steps:
    #     - uses: actions/checkout@master
    #     - name: Set up Python 3.9
    #       uses: actions/setup-python@v3
    #       with:
    #         python-version: "3.9"
    #     - name: Install dependencies
    #       run: python3 -m pip install setuptools wheel twine
    #     - name: Extract tag name
    #       id: tag
    #       run: echo ::set-output name=TAG_NAME::$(echo $GITHUB_REF | cut -d / -f 3)
    #     - name: Update version in setup.py
    #       run: sed -i "s/{{VERSION_PLACEHOLDER}}/${{ steps.tag.outputs.TAG_NAME }}/g"
    #         setup.py
    #     - name: Build a binary wheel
    #       run: python3 setup.py sdist bdist_wheel
    #     - name: Publish distribution üì¶ to PyPI
    #       uses: pypa/gh-action-pypi-publish@release/v1 # This requires a trusted publisher to be setup in pypi/testpypi

    # create-release-github: # TODO
    #   needs: needs: [build-and-publish-test-pypi, test-intro-notebook, build-and-publish-pypi]
    # Make sure to include release notes